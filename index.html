<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>OutInTheDay</title>
<style>
  body {
    background: #121212;
    color: #eee;
    font-family: sans-serif;
  }
  .search-container {
    position: sticky;
    top: 0;
    background: #1e1e1e;
    padding: 20px;
    z-index: 10;
    text-align: center;
    border-bottom: 1px solid #333;
  }
  .search-input {
    width: 80%;
    padding: 16px 20px;
    font-size: 20px;
    border: 1px solid #444;
    border-radius: 30px;
    background: #222;
    color: #eee;
    box-shadow: 0 2px 4px rgba(0,0,0,0.5);
  }
  .search-input::placeholder {
    color: #aaa;
  }
  .filter-bar {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    margin-top: 10px;
    position: relative;
  }
  .filter-toggle {
    padding: 8px 16px;
    font-size: 14px;
    border: 1px solid #444;
    border-radius: 20px;
    background: #333;
    color: #eee;
    cursor: pointer;
    position: relative;
    transition: background 0.2s, color 0.2s;
  }
  .filter-toggle:hover {
    background: #444;
  }
  .filter-toggle.active {
    background: #4285f4;
    color: #fff;
    border-color: #4285f4;
  }
  .filter-toggle.has-active {
    background: #e6b800;
    color: #000;
    border-color: #e6b800;
  }
  .filter-popdown {
    position: absolute;
    top: 100%;
    left: 0;
    margin-top: 5px;
    background: #1e1e1e;
    border: 1px solid #333;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    padding: 15px;
    border-radius: 8px;
    display: none;
    z-index: 20;
    text-align: left;
    width: 350px;
  }
  @media (max-width: 500px) {
    .filter-popdown {
      position: fixed;
      top: 60px;
      left: 10px;
      right: 10px;
      width: auto;
      border-radius: 6px;
    }
  }
  .tag-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 10px;
  }
  .tag-button {
    margin: 3px;
    padding: 8px 14px;
    font-size: 14px;
    border: 1px solid #444;
    border-radius: 4px;
    background: #333;
    color: #eee;
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
  }
  .tag-button:hover {
    background: #444;
  }
  .tag-button.active {
    background: #4285f4;
    color: #fff;
    border-color: #4285f4;
  }
  .popdown-actions {
    display: flex;
    justify-content: space-between;
    font-size: 14px;
    margin-top: 5px;
  }
  .action-link {
    color: #80bfff;
    cursor: pointer;
  }
  .cards-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 20px;
    min-height: 300px;
    align-items: flex-start;
    padding: 20px;
  }
  .event-card {
    width: 250px;
    border: 1px solid #333;
    border-radius: 8px;
    overflow: hidden;
    text-align: left;
    background: #1c1c1c;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .event-card:hover {
    transform: scale(1.03);
    box-shadow: 0 4px 12px rgba(0,0,0,0.6);
  }
  .event-card img {
    width: 100%;
    height: 150px;
    object-fit: cover;
  }
  .event-card-content {
    padding: 10px;
  }
  .event-title {
    font-weight: bold;
    margin-bottom: 5px;
    color: #fff;
  }
  .event-description {
    font-size: 14px;
    color: #ccc;
    margin-top: 6px;
  }
  .event-date {
    font-size: 13px;
    color: #bbb;
  }
</style>
</head>
<body>

<div class="search-container">
  <input type="text" class="search-input" placeholder="Search by name..." oninput="renderCards()">
  <div class="filter-bar" id="filterBar"></div>
</div>

<div class="cards-container" id="cardsContainer"></div>

<script>
let activeFilters = {
  location: [],
  setting: [],
  identity: [],
  time: [],
  accommodations: [],
  vibe: []
};
let allEvents = [];

fetch('https://raw.githubusercontent.com/Xommon/xommon.github.io/refs/heads/master/OITD_cards.json')
  .then(response => response.json())
  .then(data => {
    allEvents = data;
    generateFilters(data);
    renderCards();
  })
  .catch(err => console.error('Error loading events:', err));

function generateFilters(events) {
  const categories = ['location', 'setting', 'identity', 'time', 'accommodations', 'vibe'];
  const filterBar = document.getElementById('filterBar');
  categories.forEach(category => {
    const values = new Set();
    events.forEach(event => {
      if (event[category]) {
        event[category].forEach(v => values.add(v));
      }
    });
    const wrapper = document.createElement('div');
    const toggle = document.createElement('button');
    toggle.className = 'filter-toggle';
    toggle.dataset.pop = category;
    toggle.textContent = category.charAt(0).toUpperCase() + category.slice(1) + ' âŒ„';
    wrapper.appendChild(toggle);

    const popdown = document.createElement('div');
    popdown.className = 'filter-popdown';
    const tagContainer = document.createElement('div');
    tagContainer.className = 'tag-buttons';

    Array.from(values).sort((a,b)=>a.localeCompare(b)).forEach(value => {
      const btn = document.createElement('button');
      btn.className = 'tag-button';
      btn.dataset.category = category;
      btn.dataset.value = value.toLowerCase();
      btn.textContent = value;
      btn.addEventListener('click', () => {
        const val = value.toLowerCase();
        if (activeFilters[category].includes(val)) {
          activeFilters[category] = activeFilters[category].filter(v => v !== val);
          btn.classList.remove('active');
        } else {
          activeFilters[category].push(val);
          btn.classList.add('active');
        }
        renderCards();
        updateToggleActiveStates();
      });
      tagContainer.appendChild(btn);
    });

    popdown.appendChild(tagContainer);
    const actions = document.createElement('div');
    actions.className = 'popdown-actions';
    actions.innerHTML = `<span class="action-link clear-btn">Clear</span><span class="action-link done-btn">Done</span>`;
    popdown.appendChild(actions);
    wrapper.appendChild(popdown);
    filterBar.appendChild(wrapper);
  });

  document.querySelectorAll('.filter-toggle').forEach(button => {
    button.addEventListener('click', e => {
      e.stopPropagation();
      const pop = button.parentElement.querySelector('.filter-popdown');
      if (pop.style.display === 'block') {
        pop.style.display = 'none';
        button.classList.remove('active');
      } else {
        closePopdowns();
        pop.style.display = 'block';
        button.classList.add('active');
      }
    });
  });

  document.querySelectorAll('.clear-btn').forEach(clear => {
    clear.addEventListener('click', e => {
      const popdown = clear.closest('.filter-popdown');
      const buttons = popdown.querySelectorAll('.tag-button');
      buttons.forEach(btn => {
        btn.classList.remove('active');
        const cat = btn.dataset.category;
        const val = btn.dataset.value;
        activeFilters[cat] = activeFilters[cat].filter(v => v !== val);
      });
      renderCards();
      updateToggleActiveStates();
    });
  });

  document.querySelectorAll('.done-btn').forEach(done => {
    done.addEventListener('click', () => {
      closePopdowns();
      updateToggleActiveStates();
    });
  });

  document.addEventListener('click', e => {
    if (!e.target.closest('.filter-popdown, .filter-toggle')) {
      closePopdowns();
    }
  });
}

function closePopdowns() {
  document.querySelectorAll('.filter-popdown').forEach(p => p.style.display = 'none');
  document.querySelectorAll('.filter-toggle').forEach(b => b.classList.remove('active'));
}

function updateToggleActiveStates() {
  document.querySelectorAll('.filter-toggle').forEach(button => {
    const category = button.dataset.pop;
    if (activeFilters[category].length > 0) {
      button.classList.add('has-active');
    } else {
      button.classList.remove('has-active');
    }
  });
}

function renderCards() {
  const input = document.querySelector('.search-input').value.toLowerCase();
  const container = document.getElementById('cardsContainer');
  container.innerHTML = '';
  const sortedEvents = [...allEvents].sort((a, b) => {
    const getSortKey = title => title.toLowerCase().replace(/^(the\s+|a\s+|an\s+)/, '').trim();
    return getSortKey(a.title).localeCompare(getSortKey(b.title));
  });
  sortedEvents.forEach(event => {
    const title = event.title.toLowerCase();
    const matchesText = title.includes(input);
    let matchesFilters = true;
    for (let category in activeFilters) {
      const active = activeFilters[category];
      const eventVals = (event[category] || []).map(v => v.toLowerCase());
      if (active.length > 0 && !active.every(v => eventVals.includes(v))) {
        matchesFilters = false;
        break;
      }
    }
    if (matchesText && matchesFilters) {
      const cardLink = document.createElement('a');
      cardLink.href = event.url || '#';
      cardLink.target = '_blank';
      cardLink.style.textDecoration = 'none';
      cardLink.style.color = 'inherit';
      const card = document.createElement('div');
      card.className = 'event-card';
      const defaultImage = "https://upload.wikimedia.org/wikipedia/commons/a/a3/Image-not-found.png";
      const imageUrl = event.image && event.image.trim() !== "" ? event.image : defaultImage;

      card.innerHTML = `
        <div class="event-card-content">
          <div class="event-title">${event.title}</div>
          ${event.description ? `<div class="event-description">${event.description}</div>` : ""}
        </div>
        <img src="${imageUrl}" alt="Event Image" onerror="this.src='${defaultImage}'">
        ${event.date ? `<div class="event-card-content"><div class="event-date">${event.date}</div></div>` : ""}
      `;

      cardLink.appendChild(card);
      container.appendChild(cardLink);
    }
  });
}
document.querySelector('.search-input').addEventListener('input', renderCards);
</script>
</body>
</html>
